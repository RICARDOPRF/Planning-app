<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Duoplanning ‚Äî Mestre do Planejamento</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f1115">
  <style>
    :root { 
      --bg:#0f1115; --panel:#151923; --text:#e9eef7; --muted:#a7b1c2; --accent:#58cc02; --border:#273046; 
      --danger:#ff4d4f; --success:#27ae60;
      /* Cores por n√≠vel */
      --lv-tec:#58cc02;      /* T√©cnico */
      --lv-ana:#3aa0ff;      /* Analista */
      --lv-esp:#7e57c2;      /* Especialista */
      --lv-ger:#f2b01c;      /* Gerente/Diretor */
      --lv-vis:#00bcd4;      /* Vision√°rio */
    }
    html,body{width:100%;height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;overflow-x:hidden}
    .wrap{max-width:480px;margin:0 auto;padding:16px; min-height: 100vh; display: flex; flex-direction: column;}
    h1,h2,h3{margin:0 0 10px;line-height:1.2}
    .hidden{display:none !important}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    input,select,button{font-size:16px;padding:12px;border-radius:10px;border:1px solid var(--border);background:#1b2230;color:var(--text);box-sizing:border-box; outline:none;}
    input:focus, select:focus{border-color:var(--accent);}
    input,select{width:100%}
    button.primary{background:var(--accent);color:#fff;border:none;cursor:pointer;transition:.2s; font-weight: 600;}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--text); cursor: pointer;}
    button.primary:hover{opacity:.9; transform: translateY(-1px);}
    button:active{transform: scale(0.98);}
    button:disabled{opacity: 0.5; cursor: not-allowed; filter: grayscale(1);}
    
    .meta{color:var(--muted);font-size:14px}
    #topBar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    #topBar h1{font-size:20px; font-weight: 800; letter-spacing: -0.5px;}
    #topBar .actions{display:flex;gap:8px}
    
    .xp{display:flex;align-items:center;gap:8px; margin-top: 8px;}
    .xpbar{flex:1;height:10px;background:#0e1522;border:1px solid var(--border);border-radius:999px;overflow:hidden; position: relative;}
    .xpbar > i{display:block;height:100%;background:var(--accent);width:0; transition: width 0.5s ease-out; box-shadow: 0 0 10px var(--accent);}
    
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .card{background:#0e1522;border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;position:relative; transition: .2s;}
    .card:active{background: #131b29;}
    .card h4{margin:0;font-size:14px; line-height: 1.3;}
    .icon{font-size:24px; margin-bottom: 4px;}
    .ribbon{position:absolute;inset:12px auto 12px 0;width:3px;border-radius:0 4px 4px 0;background:var(--accent)}
    
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:11px;padding:4px 8px;border-radius:999px;background:#0f1722;border:1px solid var(--border); font-weight: 600; text-transform: uppercase;}
    
    /* Cores din√¢micas */
    .lv-tec{--lv:var(--lv-tec)} .lv-ana{--lv:var(--lv-ana)} .lv-esp{--lv:var(--lv-esp)} .lv-ger{--lv:var(--lv-ger)} .lv-vis{--lv:var(--lv-vis)}
    .lv .ribbon{background:var(--lv)} 
    .lv .chip{border-color:color-mix(in srgb, var(--lv) 40%, transparent); color: var(--lv);}
    .lv .primary{background:var(--lv)}
    
    .mod-footer{display:flex;align-items:center;justify-content:space-between; margin-top: auto; padding-top: 8px;}
    .status{font-size:11px;opacity:.8; font-weight: 500;}
    .status.done{color:var(--success)} .status.lock{color:var(--muted)}
    
    .lock-overlay{position:absolute; inset:0; background:rgba(15, 17, 21, 0.6); display:flex; align-items:center; justify-content:center; border-radius:14px; backdrop-filter: blur(1px);}
    .lock-icon{font-size: 24px; opacity: 0.7;}
    .card.locked{opacity:1; pointer-events: none;} 

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:16px;z-index:100; backdrop-filter: blur(3px);}
    .sheet{max-width:480px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 90vh;}
    .sheet .head{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border); background: rgba(0,0,0,0.2);}
    .sheet .body{padding:16px; overflow-y: auto;}
    
    .q{font-size:18px;margin:0 0 16px; font-weight: 500;}
    .opts{display:grid;gap:10px}
    .opt{padding:14px;border:1px solid var(--border);border-radius:12px;background:#131b29;cursor:pointer; transition: .2s; font-size: 15px;}
    .opt:hover{background: #1c263a;}
    .opt.correct{border-color:var(--success);background:rgba(39, 174, 96, 0.15); color: #4ade80;}
    .opt.wrong{border-color:var(--danger);background:rgba(255, 77, 79, 0.15); opacity: 0.7;}
    
    .exp{border-left:3px solid var(--accent);padding:12px;margin-top:16px;background:#0f1622; border-radius: 0 8px 8px 0; font-size: 14px; line-height: 1.4;}
    .foot{display:flex;align-items:center;justify-content:space-between;margin-top:20px}
    
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#1e293b;border:1px solid var(--border);border-radius:999px;padding:12px 20px;color:#fff;display:none;z-index:200; box-shadow: 0 10px 20px rgba(0,0,0,0.3); font-weight: 500; white-space: nowrap;}
    
    @media (max-width:600px){.row{flex-direction:column;align-items:stretch}.grid{grid-template-columns:1fr}.panel{padding:16px}}
    
    /* Anima√ß√µes */
    @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
    .panel, .card { animation: slideUp 0.4s ease-out; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="topBar" class="hidden">
      <h1>Duoplanning</h1>
      <div class="actions">
        <span id="userBadge" class="meta" style="font-size:11px; border:1px solid var(--border); padding:4px 8px; border-radius:8px;"></span>
        <button id="btnRank" class="ghost" style="padding:8px">üèÜ</button>
        <button id="btnConfig" class="ghost" style="padding:8px">‚öôÔ∏è</button>
        <button id="btnLogout" class="ghost" style="font-size:12px; padding: 8px 12px;">Sair</button>
      </div>
    </div>

    <section id="viewLogin" class="panel">
      <div style="text-align:center; margin-bottom:20px;">
        <h1 style="font-size:28px; color:var(--accent)">Duoplanning</h1>
        <p class="meta">Domine o Planejamento de Obras</p>
      </div>
      
      <h2>Entrar</h2>
      <div class="row">
        <button id="btnGoogle" class="primary" style="width:100%; background:#fff; color:#000; border-color:#fff;">
          <span style="margin-right:8px">G</span> Entrar com Google
        </button>
        <div style="display:flex;align-items:center;gap:8px;width:100%; margin: 10px 0;">
          <div style="height:1px;background:var(--border);flex:1"></div>
          <span class="meta">ou teste local</span>
          <div style="height:1px;background:var(--border);flex:1"></div>
        </div>
        <input id="inpName" type="text" placeholder="Seu nome" />
        <button id="btnLocal" class="ghost" style="width:100%">Come√ßar sem Login</button>
      </div>
    </section>

    <section id="viewDash" class="hidden">
      <div class="panel" style="padding-bottom: 24px;">
        <div class="row" style="justify-content:space-between; margin-bottom:10px;">
          <h2 id="hello" style="margin:0">Bem-vindo!</h2>
          <div id="userLvlDisplay" class="chip lv-tec" style="font-size:12px">T√©cnico</div>
        </div>
        <div class="xp">
          <span id="xpText" style="font-weight:600; font-variant-numeric: tabular-nums;">0 / 1000 XP</span>
        </div>
        <div class="xpbar"><i id="xpFill"></i></div>
      </div>

      <div class="panel">
        <h3>Miss√µes Ativas</h3>
        <div class="grid">
          <div class="card lv lv-tec">
            <span class="ribbon"></span>
            <h4>‚ö° Miss√£o Di√°ria</h4>
            <div class="meta" style="font-size:12px">Acerte 3 perguntas (+20 XP)</div>
            <button class="primary" id="btnDaily" style="margin-top:8px; font-size:13px; padding:8px;">Jogar Agora</button>
          </div>
          <div class="card lv lv-ana">
            <span class="ribbon"></span>
            <h4>üìÖ Miss√£o Semanal</h4>
            <div class="meta" style="font-size:12px" id="wkStatus">Complete 3 m√≥dulos</div>
            <button class="primary" id="btnWeekly" style="margin-top:8px; font-size:13px; padding:8px;" disabled>Resgatar (+100 XP)</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Trilha de Aprendizado</h3>
        <div id="legend" class="meta" style="margin:8px 0 16px; display:flex; flex-wrap:wrap; gap:6px;"></div>
        <div id="mods" class="grid"></div>
      </div>
    </section>
  </div>

  <div id="quiz" class="overlay">
    <div class="sheet">
      <div class="head"><strong id="quizTitle">Quiz</strong><button id="btnCloseQuiz" class="ghost" style="padding:6px 12px; font-size:12px;">Fechar</button></div>
      <div class="body">
        <div id="qText" class="q">Pergunta</div>
        <div id="opts" class="opts"></div>
        <div id="exp" class="exp hidden"></div>
        <div class="foot">
          <div id="qProg" class="meta">1/10</div>
          <button id="btnNext" class="primary hidden">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="config" class="overlay">
    <div class="sheet">
      <div class="head"><strong>Configura√ß√µes</strong><button id="btnCloseConfig" class="ghost">x</button></div>
      <div class="body">
        <div class="opts">
          <div class="row" style="justify-content:space-between">
            <label>üéâ Confetes</label>
            <input type="checkbox" id="cfgConfetti" style="width:auto">
          </div>
          <div class="row" style="justify-content:space-between">
            <label>üîä Efeitos Sonoros</label>
            <input type="checkbox" id="cfgSound" style="width:auto">
          </div>
          <div class="row" style="justify-content:space-between">
            <label>üéì Exigir 70% para passar</label>
            <input type="checkbox" id="cfgRequire70" checked style="width:auto">
          </div>
        </div>
        <hr style="border-color:var(--border);opacity:.3;margin:20px 0">
        <button id="btnReset" class="ghost" style="width:100%; border-color:var(--danger); color:var(--danger)">Zerar todo progresso</button>
      </div>
    </div>
  </div>

  <div id="ranking" class="overlay">
    <div class="sheet">
      <div class="head"><strong>üèÜ Ranking Global</strong><button id="btnCloseRank" class="ghost">x</button></div>
      <div class="body" id="rankBody" style="min-height:200px">
        <p class="meta">Carregando...</p>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Notifica√ß√£o</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAVT6M_mEll69i2S5Btbe2Xpu0gcvB4L4",
      authDomain: "duoplanning-90738.firebaseapp.com",
      projectId: "duoplanning-90738",
      storageBucket: "duoplanning-90738.firebasestorage.app",
      messagingSenderId: "166228868261",
      appId: "1:166228868261:web:441565bc95d238e8d6614c",
      measurementId: "G-24JXV1HEJW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ===========================================
    // 1. DADOS E CONSTANTES (LOAD FIRST)
    // ===========================================

    const LEVELS = [
      {id:'Tecnico',label:'T√©cnico',icon:'üë∑‚Äç‚ôÇÔ∏è',color:'var(--lv-tec)',xp:30},
      {id:'Analista',label:'Analista',icon:'üë®‚Äçüíª',color:'var(--lv-ana)',xp:40},
      {id:'Especialista',label:'Especialista',icon:'üë®‚Äçüîß',color:'var(--lv-esp)',xp:50},
      {id:'Gerente',label:'Gerente',icon:'üëî',color:'var(--lv-ger)',xp:60},
      {id:'Visionario',label:'Vision√°rio',icon:'üîÆ',color:'var(--lv-vis)',xp:80}
    ];

    // IDs que comp√µem o n√≠vel t√©cnico para l√≥gica de bloqueio
    const TEC_IDS = [1,2,3,4,5,6,7,8,9,10,11,12];

    const MODULES = [
      // T√âCNICO
      { id: 1, title: 'LPS ‚Äî Last Planner System', level: 'Tecnico', icon: 'üü¢' },
      { id: 2, title: 'Cronograma ‚Äî L√≥gica e EAP', level: 'Tecnico', icon: 'üîµ' },
      { id: 3, title: 'Programa√ß√£o Semanal', level: 'Tecnico', icon: 'üóÇÔ∏è' },
      { id: 4, title: 'Folha Tarefa ‚Äî Ader√™ncia', level: 'Tecnico', icon: 'üìä' },
      { id: 5, title: 'Produtos Not√°veis (Produtividade)', level: 'Tecnico', icon: 'üìà' },
      { id: 6, title: 'Painel de Bordo (Indicadores)', level: 'Tecnico', icon: 'üìä' },
      { id: 7, title: 'Rundown / Curva S', level: 'Tecnico', icon: 'üìâ' },
      { id: 8, title: '√çndices & Produtividade', level: 'Tecnico', icon: 'üîß' },
      { id: 9, title: 'Reuni√µes Lean', level: 'Tecnico', icon: 'üë•' },
      { id:10, title: 'Restri√ß√µes e Lookahead', level: 'Tecnico', icon: 'üöß' },
      { id:11, title: 'Waste Time', level: 'Tecnico', icon: 'üü†' },
      { id:12, title: 'As-Built e Fechamento', level: 'Tecnico', icon: 'üìã' },
      // ANALISTA
      { id:13, title: 'Linha de Produ√ß√£o (Lean)', level: 'Analista', icon: 'üî•' },
      { id:14, title: 'Alinhamento Eng x Plan', level: 'Analista', icon: 'üß©' },
      { id:15, title: 'Produtividade e Efetivo', level: 'Analista', icon: 'üöÄ' },
      { id:16, title: 'Cadeia de Suprimentos', level: 'Analista', icon: 'üîó' },
      { id:17, title: 'Equipamentos e Log√≠stica', level: 'Analista', icon: '‚öôÔ∏è' },
      { id:18, title: 'Inspe√ß√µes e Qualidade', level: 'Analista', icon: 'üîç' },
      { id:19, title: 'Integra√ß√£o com Seguran√ßa', level: 'Analista', icon: 'üî•' },
      { id:20, title: 'Comissionamento e Entrega', level: 'Analista', icon: '‚ö°' },
      // ESPECIALISTA
      { id:21, title: 'Gest√£o de Interfaces', level: 'Especialista', icon: 'üü£' },
      { id:22, title: 'Planejamento BIM 4D', level: 'Especialista', icon: 'üß©' },
      { id:23, title: 'Grandes Paradas', level: 'Especialista', icon: '‚öôÔ∏è' },
      { id:24, title: 'Log√≠stica Avan√ßada', level: 'Especialista', icon: 'üöö' },
      { id:25, title: 'An√°lise de KPIs Avan√ßados', level: 'Especialista', icon: 'üìä' },
      { id:26, title: 'Gest√£o de Mudan√ßas', level: 'Especialista', icon: 'üîÑ' },
      { id:27, title: 'Curva de Aprendizado', level: 'Especialista', icon: 'üî¨' },
      { id:28, title: 'Resolu√ß√£o de Problemas', level: 'Especialista', icon: 'üß†' },
      { id:29, title: 'Planejamento Orientado a Valor', level: 'Especialista', icon: 'üèóÔ∏è' },
      { id:30, title: 'Controle em Tempo Real', level: 'Especialista', icon: 'üõ∞Ô∏è' },
      // GERENTE
      { id:31, title: 'Lideran√ßa no Planejamento', level: 'Gerente', icon: 'üëî' },
      { id:32, title: 'Custos e Or√ßamento', level: 'Gerente', icon: 'üí∞' },
      { id:33, title: 'Gest√£o de Riscos', level: 'Gerente', icon: '‚ö†Ô∏è' },
      { id:34, title: 'Comunica√ß√£o Executiva', level: 'Gerente', icon: 'üéØ' },
      { id:35, title: 'AWP Integrado', level: 'Gerente', icon: 'üßÆ' },
      { id:36, title: 'Tomada de Decis√£o', level: 'Gerente', icon: 'üß®' },
      // VISION√ÅRIO
      { id:37, title: 'IA na Obra', level: 'Visionario', icon: 'ü§ñ' },
      { id:38, title: 'Planejamento 5D', level: 'Visionario', icon: 'üõ∞Ô∏è' },
      { id:39, title: 'Power BI Integrado', level: 'Visionario', icon: 'üì°' },
      { id:40, title: 'Simula√ß√µes Monte Carlo', level: 'Visionario', icon: 'üß¨' }
    ];

    const DB_QUIZ = {
      // MOD 1: LPS
      1: [
        {q:'Qual o principal objetivo do PPC?',opts:['Medir lucro financeiro','Medir ader√™ncia do planejado x realizado','Medir satisfa√ß√£o do cliente'],ok:1,exp:'PPC (Percent Plan Complete) mede quantos pacotes foram conclu√≠dos conforme prometido na semana.'},
        {q:'Quem s√£o os Last Planners (√öltimos Planejadores)?',opts:['Gerentes de Contrato','Diretores da empresa','Encarregados e l√≠deres de frente'],ok:2,exp:'S√£o as pessoas que est√£o na ponta da execu√ß√£o e definem o que realmente ser√° feito.'},
        {q:'A base do plano semanal deve conter:',opts:['Todas as atividades do cronograma','Somente atividades prontas e liberadas','Atividades que est√£o atrasadas, mesmo sem material'],ok:1,exp:'No LPS, s√≥ entra na semana o que tem restri√ß√£o removida e recurso dispon√≠vel.'},
        {q:'O que fazer com restri√ß√µes identificadas?',opts:['Ignorar e seguir','Deixar para resolver no dia','Tratar antes de planejar a execu√ß√£o'],ok:2,exp:'Restri√ß√µes (projetos, materiais, acesso) devem ser removidas no Lookahead, antes da semana.'},
        {q:'Como devem ser as reuni√µes do LPS?',opts:['Longas e detalhadas','Dailys r√°pidas e objetivas','Mensais com diretoria'],ok:1,exp:'Foco em alinhamento r√°pido, confirma√ß√£o de metas e remo√ß√£o de travas.'},
        {q:'O que um PPC baixo recorrente indica?',opts:['Equipe trabalhando muito','Falhas no planejamento ou restri√ß√µes n√£o tratadas','Sucesso do projeto'],ok:1,exp:'Indica instabilidade e falta de confiabilidade no sistema.'},
        {q:'Quem deve preencher a Folha Tarefa?',opts:['O estagi√°rio na sala t√©cnica','Encarregados / L√≠deres de campo','O cliente'],ok:1,exp:'Quem executa sabe o que foi feito. O preenchimento deve ser na ponta.'},
        {q:'ICP e IPP medem principalmente:',opts:['Causas de falha e √≠ndice de prontid√£o','Lucro e Preju√≠zo','Temperatura do ambiente'],ok:0,exp:'√çndices de Confiabilidade e Prontid√£o ajudam a diagnosticar a sa√∫de do fluxo.'}
      ],
      // MOD 2: CRONOGRAMA
      2: [
        {q:'O Caminho Cr√≠tico √© a sequ√™ncia de atividades que:',opts:['Tem maior custo','N√£o tem folga (determina o prazo final)','√â mais f√°cil de fazer'],ok:1,exp:'Qualquer atraso no caminho cr√≠tico impacta a entrega da obra.'},
        {q:'Para que serve a EAP (Estrutura Anal√≠tica do Projeto)?',opts:['Organizar entreg√°veis em pacotes','Calcular fluxo de caixa','Definir quem √© o chefe'],ok:0,exp:'Decomp√µe o escopo total em partes gerenci√°veis.'},
        {q:'Qual a melhor forma de controlar o avan√ßo f√≠sico?',opts:['Perguntar ao mestre','Curva S com pesos ponderados','Verificar nota fiscal'],ok:1,exp:'A Curva S f√≠sica compara o planejado x realizado baseado no peso de cada atividade.'},
        {q:'Para usar √≠ndices de produtividade, √© preciso ter:',opts:['Quantidades detalhadas e confi√°veis','Apenas o valor total do contrato','Muitos engenheiros'],ok:0,exp:'Sem a quantidade exata (m¬≥, ton, m), o √≠ndice n√£o reflete a realidade.'},
        {q:'A sequ√™ncia l√≥gica do cronograma deve considerar:',opts:['Apenas o desejo do cliente','Interfer√™ncias reais e construtibilidade','A ordem alfab√©tica'],ok:1,exp:'N√£o adianta planejar solda antes da pr√©-montagem (erro de l√≥gica).'},
        {q:'Quando se deve reprogramar (Baseline)?',opts:['Toda semana','Nunca','Quando h√° desvio que afeta o prazo final irreversivelmente'],ok:2,exp:'Mudan√ßa de linha de base deve ser criteriosa para n√£o perder o hist√≥rico.'},
        {q:'A Linha de Base (Baseline) serve para:',opts:['Bonificar a equipe','Comparar varia√ß√µes (Previsto x Real)','Travar o software'],ok:1,exp:'√â a refer√™ncia congelada do plano original.'},
        {q:'A dura√ß√£o correta de uma tarefa depende de:',opts:['Chute do gerente','√çndice de produtividade e quantidade a executar','Data que o cliente quer'],ok:1,exp:'Dura√ß√£o = Quantidade x √çndice / Recursos.'}
      ],
      // MOD 3: PROGRAMA√á√ÉO SEMANAL
      3: [
        {q:'Quem deve planejar a semana de trabalho?',opts:['O planejador sozinho','Os Last Planners (Executores)','O diretor'],ok:1,exp:'Planejamento colaborativo garante compromisso real.'},
        {q:'Uma atividade programada e n√£o conclu√≠da vira:',opts:['Um problema esquecido','WNC (Why Not Completed) / Causa Raiz','Hora extra autom√°tica'],ok:1,exp:'Deve-se analisar o motivo do n√£o cumprimento para n√£o repetir o erro.'},
        {q:'O plano semanal precisa garantir:',opts:['Recursos + Frente Liberada + Sem restri√ß√µes','Apenas vontade de fazer','M√°ximo de atividades poss√≠vel'],ok:0,exp:'S√≥ se promete o que se pode cumprir (Confiabilidade).'},
        {q:'Como definir a prioridade das equipes?',opts:['Quem gritar mais alto','Caminho cr√≠tico e gargalos de produ√ß√£o','Sorteio'],ok:1,exp:'Focar no que libera as pr√≥ximas etapas ou impacta o prazo final.'},
        {q:'O que um PPC baixo na semana indica?',opts:['Chuva excessiva sempre','Falta de preparo ou planejamento ruim','Azar'],ok:1,exp:'Geralmente mostra que enviamos trabalho com restri√ß√£o para o campo.'},
        {q:'Qual a ferramenta de controle di√°rio do plano semanal?',opts:['E-mail','Folha Tarefa / Di√°rio de Obra','WhatsApp'],ok:1,exp:'Registro formal do que foi feito vs planejado dia a dia.'},
        {q:'Qual a dura√ß√£o ideal do plano de curto prazo?',opts:['1 m√™s','Apenas a semana (ou quinzena)','1 ano'],ok:1,exp:'Foco total na execu√ß√£o imediata com alta precis√£o.'},
        {q:'Qual t√©cnica Lean √© aplicada na programa√ß√£o semanal?',opts:['Empurrar produ√ß√£o','Pull Planning (Puxar produ√ß√£o)','Estoque infinito'],ok:1,exp:'Produzir o que a pr√≥xima etapa precisa, quando precisa.'}
      ],
      // MOD 4: FOLHA TAREFA
      4: [
        {q:'Qual o objetivo principal da Folha Tarefa?',opts:['Gerar papelada','Confirmar execu√ß√£o di√°ria e alimentar o PPC','Vigiar hor√°rio de almo√ßo'],ok:1,exp:'√â o documento que traz a verdade do campo para o planejamento.'},
        {q:'Quem valida as informa√ß√µes da Folha Tarefa?',opts:['O porteiro','Encarregado da frente + Planejamento','O fornecedor'],ok:1,exp:'Valida√ß√£o conjunta garante que o dado √© real.'},
        {q:'Qual a causa mais comum de queda no PPC vista na folha?',opts:['Falta de material ou frente impedida','Falta de caf√©','Excesso de sol'],ok:0,exp:'Restri√ß√µes f√≠sicas s√£o os maiores vil√µes da produtividade.'},
        {q:'Muitos itens "Vermelhos" (n√£o feitos) na folha indicam:',opts:['Equipe pregui√ßosa','Falhas de fluxo e libera√ß√£o de servi√ßo','Nada de mais'],ok:1,exp:'Sinaliza que o plano enviado n√£o estava pronto para ser executado.'},
        {q:'Se houve atraso no dia, o que deve ser registrado?',opts:['Uma desculpa','A Causa Raiz real','Nada'],ok:1,exp:'Sem registrar a causa, n√£o conseguimos aplicar melhoria cont√≠nua.'},
        {q:'Qual o resultado principal da boa gest√£o da Folha Tarefa?',opts:['Ader√™ncia di√°ria e confiabilidade dos dados','Aumento de reuni√µes','Mais burocracia'],ok:0,exp:'Permite agir r√°pido corrigindo desvios.'},
        {q:'Quando a Folha Tarefa deve ser atualizada?',opts:['No final do m√™s','No in√≠cio (check-in) e fim do dia (check-out)','Quando der tempo'],ok:1,exp:'Gest√£o em tempo real (ou D-1) √© essencial.'},
        {q:'Qual a liga√ß√£o da Folha Tarefa com o LPS?',opts:['Nenhuma','Ajuste imediato no plano e c√°lculo do PPC','Serve para demitir'],ok:1,exp:'Ela √© o instrumento de coleta do Percent Plan Complete.'}
      ],
      // MOD 5: PRODUTIVIDADE (PRODUTOS NOT√ÅVEIS)
      5: [
        {q:'Para que √© utilizado o √çndice de Produtividade (RUP)?',opts:['Para pagar sal√°rios','Planejar horas necess√°rias e medir efici√™ncia','Para comprar EPI'],ok:1,exp:'Ajuda a dimensionar equipes e prever prazos.'},
        {q:'Se o √≠ndice est√° piorando (aumentando HH/unidade), indica:',opts:['Equipe r√°pida','Gargalos, retrabalho ou perda de efici√™ncia','Sucesso'],ok:1,exp:'Gastando mais horas para fazer a mesma quantidade.'},
        {q:'O que causa baixa produtividade mesmo com equipe cheia?',opts:['Falta de motiva√ß√£o apenas','Restri√ß√£o n√£o tratada (material, acesso, projeto)','Muito feriado'],ok:1,exp:'Gente parada esperando recurso destr√≥i a produtividade.'},
        {q:'Como s√£o calculadas as horas previstas?',opts:['Quantidade a fazer x √çndice or√ßado','Quantidade x Pre√ßo','Chute'],ok:0,exp:'Ex: 100m x 0,5hh/m = 50hh previstas.'},
        {q:'Qual a melhor forma de acompanhamento visual?',opts:['Planilha oculta','Dashboard de produtividade compartilhado','E-mail longo'],ok:1,exp:'O time precisa ver se est√° ganhando ou perdendo o jogo.'},
        {q:'As condi√ß√µes de campo (chuva, altura, acesso) influenciam o √≠ndice?',opts:['N√£o, o √≠ndice √© fixo','Sim, muito','Pouco'],ok:1,exp:'Trabalho em altura ou confinado √© sempre menos produtivo que no solo.'},
        {q:'Qual a melhor a√ß√£o para recuperar um √≠ndice ruim?',opts:['Contratar mais gente sem an√°lise','Reduzir movimenta√ß√£o, esperas e remover travas','Gritar com a equipe'],ok:1,exp:'Lean: eliminar desperd√≠cios para que o trabalho flua.'},
        {q:'Qual √°rea costuma ter maior varia√ß√£o de produtividade?',opts:['Pintura de parede','Tubula√ß√£o/Montagem em altura ou Pipe-rack','Limpeza'],ok:1,exp:'A complexidade de acesso e log√≠stica impacta muito a montagem industrial.'}
      ],
      // MOD 6: PAINEL DE BORDO
      6: [
        {q:'Qual o principal indicador do avan√ßo da obra?',opts:['Valor gasto','% F√≠sico Real x Planejado (Curva S)','N√∫mero de e-mails'],ok:1,exp:'Mostra se a obra est√° andando na velocidade correta.'},
        {q:'O Painel de Bordo (Dashboard) deve ser:',opts:['Complexo e cheio de texto','Simples, objetivo e visual','Apenas para o gerente'],ok:1,exp:'Deve permitir entender o status em 5 segundos.'},
        {q:'O painel deve integrar quais indicadores?',opts:['Apenas financeiro','Produtividade, PPC, Curva S e Restri√ß√µes','Aniversariantes do m√™s'],ok:1,exp:'Vis√£o 360¬∫: Prazo, Efici√™ncia e Confiabilidade.'},
        {q:'Qual a frequ√™ncia m√≠nima de atualiza√ß√£o do painel?',opts:['Mensal','Semanal (idealmente di√°ria para alguns KPIs)','Anual'],ok:1,exp:'Informa√ß√£o velha n√£o serve para tomada de decis√£o.'},
        {q:'Para que serve o painel de bordo?',opts:['Decora√ß√£o','Tomada de decis√£o baseada em dados','Impressionar visitas'],ok:1,exp:'Transformar dados em a√ß√£o corretiva.'},
        {q:'A transpar√™ncia dos dados no painel gera:',opts:['Medo','Alinhamento e engajamento do time','Confus√£o'],ok:1,exp:'Todos sabem onde est√£o os problemas e podem ajudar.'},
        {q:'Qual o melhor local para o painel?',opts:['Gaveta do gerente','√Årea comum da equipe (Obra ou Sala T√©cnica)','Arquivo morto'],ok:1,exp:'Gest√£o √† Vista deve estar... √† vista.'},
        {q:'O que facilita a leitura r√°pida do painel?',opts:['Textos longos','Codifica√ß√£o de cores (Verde/Amarelo/Vermelho)','Fontes pequenas'],ok:1,exp:'Semaforiza√ß√£o indica onde precisa de aten√ß√£o imediata.'}
      ],
      // MOD 7: RUNDOWN
      7: [
        {q:'O que a Curva S mostra?',opts:['Acumulado de Planejado vs Realizado ao longo do tempo','Apenas o custo mensal','O estoque de material'],ok:0,exp:'Permite ver a tend√™ncia de atraso ou adiantamento.'},
        {q:'Para que serve o gr√°fico de Rundown?',opts:['Mostrar o saldo restante (queima de estoque/tarefas)','Mostrar o lucro','Mostrar efetivo'],ok:0,exp:'Visualiza quanto falta fazer para zerar o escopo.'},
        {q:'Um "Gap negativo" entre as curvas indica:',opts:['Lucro','Atraso (Realizado abaixo do Planejado)','Adiantamento'],ok:1,exp:'A obra entregou menos do que deveria at√© a data.'},
        {q:'Se a Curva Real est√° ACIMA da Planejada, significa:',opts:['Adiantamento (mas aten√ß√£o √† sequ√™ncia)','Preju√≠zo','Erro de sistema'],ok:0,exp:'Entregou mais volume que o previsto (necess√°rio checar se foi no caminho cr√≠tico).'},
        {q:'Quem √© o respons√°vel principal por gerar esses gr√°ficos?',opts:['Suprimentos','Planejamento e Controle','RH'],ok:1,exp:'O setor de Planejamento consolida os dados de avan√ßo.'},
        {q:'Qual a primeira a√ß√£o ao detectar atraso na Curva S?',opts:['Desistir','Analisar causas e replanejar frentes (Plano de A√ß√£o)','Esconder o gr√°fico'],ok:1,exp:'Identificar onde descolou e agir para recuperar.'},
        {q:'Qual o dado base para a Curva S F√≠sica?',opts:['Dinheiro gasto','Pesos ponderados ou Quantidades conclu√≠das','Horas extras'],ok:1,exp:'Reflete o avan√ßo t√©cnico da obra, n√£o o financeiro.'},
        {q:'O Rundown ajuda a estabelecer:',opts:['Metas semanais para recuperar o atraso','Feriados','Sal√°rios'],ok:0,exp:'"Para acabar no prazo, preciso fazer X unidades por semana a partir de agora".'}
      ],
      // MOD 8: √çNDICES
      8: [
        {q:'A produtividade √© definida matematicamente como:',opts:['Sorte x Vontade','Output (Produ√ß√£o) / Input (Recurso/Horas)','Dinheiro / Tempo'],ok:1,exp:'Exemplo: M¬≤ pintados dividido por Homem-hora gasto.'},
        {q:'Os √≠ndices hist√≥ricos ajudam a:',opts:['Simular cen√°rios futuros com precis√£o','Fazer festas','Nada'],ok:0,exp:'Usar dados de obras passadas melhora a assertividade das novas.'},
        {q:'Quem √© o pior vil√£o da produtividade no campo?',opts:['Chuva','Deslocamento excessivo e espera (Ociosidade)','Ferramentas novas'],ok:1,exp:'Tempo gasto andando ou esperando n√£o agrega valor.'},
        {q:'Qual indicador est√° diretamente ligado √† produtividade?',opts:['HH por unidade (Raz√£o Unit√°ria)','Taxa de juros','Pre√ßo do a√ßo'],ok:0,exp:'Mede o esfor√ßo necess√°rio para produzir uma unidade.'},
        {q:'Melhorar o fluxo de trabalho faz:',opts:['A produtividade subir','A produtividade cair','Nada acontecer'],ok:0,exp:'Fluxo cont√≠nuo sem paradas √© o segredo da alta performance.'},
        {q:'A medi√ß√£o di√°ria de produ√ß√£o permite:',opts:['Ajuste r√°pido de rota','Apenas registro hist√≥rico','Burocracia'],ok:0,exp:'N√£o espere o fim do m√™s para descobrir que a meta n√£o foi batida.'},
        {q:'Existem √≠ndices "fixos" universais?',opts:['Sim, toda obra √© igual','N√£o, variam conforme condi√ß√µes de campo e complexidade','Sim, tabela SINAPI √© absoluta'],ok:1,exp:'Cada obra tem sua log√≠stica, clima e especificidade.'},
        {q:'Para ser confi√°vel, a medi√ß√£o de campo deve ser:',opts:['Frequente, criteriosa e validada','Feita por estimativa','Feita do escrit√≥rio'],ok:0,exp:'Dados ruins geram decis√µes ruins (GIGO).'}
      ],
      // MOD 9: REUNI√ïES LEAN
      9: [
        {q:'Uma Reuni√£o Lean deve ser:',opts:['Longa e detalhada','Objetiva, r√°pida e com prop√≥sito claro','Um mon√≥logo do chefe'],ok:1,exp:'Foco em resolu√ß√£o de problemas e alinhamento.'},
        {q:'Qual o tempo m√°ximo recomendado para reuni√µes di√°rias (Dailys)?',opts:['1 hora','15 minutos (em p√©)','30 segundos'],ok:1,exp:'Stand-up meetings devem ser curtas para n√£o travar a equipe.'},
        {q:'Quem deve participar das reuni√µes de programa√ß√£o?',opts:['Apenas diretores','L√≠deres da execu√ß√£o (Encarregados/Mestres)','Fornecedores de caf√©'],ok:1,exp:'Quem vai executar precisa estar no acordo.'},
        {q:'O PPC deve ser exibido na reuni√£o?',opts:['N√£o, √© segredo','Sim, sempre, para gerar transpar√™ncia','Talvez'],ok:1,exp:'O time precisa saber se cumpriu o combinado da semana anterior.'},
        {q:'O termo "Gemba" significa:',opts:['Escrit√≥rio central','Ir ao local onde as coisas acontecem (Campo)','Sala de reuni√£o'],ok:1,exp:'Gest√£o real se faz vendo o problema no local.'},
        {q:'Para que serve o quadro visual na reuni√£o?',opts:['Alinhamento imediato de todos','Decorar a parede','Esconder problemas'],ok:0,exp:'Facilita que todos vejam as mesmas prioridades e restri√ß√µes.'},
        {q:'O que se deve evitar em reuni√µes de produ√ß√£o?',opts:['Resolver problemas','Burocracia excessiva e conversas paralelas','Definir metas'],ok:1,exp:'Foco no plano e nas restri√ß√µes.'},
        {q:'Qual o resultado esperado de uma boa reuni√£o semanal?',opts:['Ata assinada apenas','Plano de trabalho ajustado e compromissos firmados','Cansa√ßo'],ok:1,exp:'Todos saem sabendo o que devem fazer na semana.'}
      ],
      // MOD 10: RESTRI√á√ïES
      10: [
        {q:'O que √© uma Restri√ß√£o no planejamento?',opts:['Uma regra do governo','Algo que impede o in√≠cio ou continuidade de uma tarefa','Um erro de projeto'],ok:1,exp:'Falta de material, projeto, acesso, equipamento, libera√ß√£o.'},
        {q:'Onde as restri√ß√µes devem ser registradas?',opts:['Na cabe√ßa do engenheiro','Em planilha de controle ou gest√£o visual (Lookahead)','No di√°rio oficial'],ok:1,exp:'Deve ser monitorada at√© ser eliminada.'},
        {q:'Qual o momento ideal para tratar uma restri√ß√£o?',opts:['No dia da execu√ß√£o','Antes de planejar a atividade para a semana (M√©dio Prazo)','Depois que parou a obra'],ok:1,exp:'Antecipar problemas √© a ess√™ncia do Lookahead.'},
        {q:'S√£o exemplos de restri√ß√µes t√≠picas:',opts:['Material, Seguran√ßa, Projetos/Engenharia, Acesso','Chuva e Sol','Feriados'],ok:0,exp:'Itens que bloqueiam a produ√ß√£o.'},
        {q:'Uma restri√ß√£o de material recorrente (RNC) indica:',opts:['Azar','Falha no fluxo de suprimentos ou log√≠stica','Problema do fornecedor apenas'],ok:1,exp:'Exige an√°lise de causa raiz no processo de compras/entrega.'},
        {q:'O planejamento deve fazer o que com atividades restritas?',opts:['Colocar na meta para pressionar','Bloquear sua ida para o plano semanal','Ignorar'],ok:1,exp:'Nunca envie servi√ßo travado para o campo (gera improdutividade).'},
        {q:'Quem √© o "Dono" da restri√ß√£o?',opts:['Sempre o gerente','Quem tem o poder de elimin√°-la (ex: Suprimentos para material)','O estagi√°rio'],ok:1,exp:'Cada restri√ß√£o deve ter um respons√°vel e um prazo.'},
        {q:'Qual a frequ√™ncia de acompanhamento das restri√ß√µes?',opts:['Mensal','Di√°ria ou Semanal (no Lookahead)','Anual'],ok:1,exp:'As travas precisam ser removidas constantemente.'}
      ],
      // MOD 11: WASTE TIME
      11: [
        {q:'O que o indicador "Waste Time" mede?',opts:['Tempo de descanso','Horas desperdi√ßadas / improdutivas','Tempo de chuva'],ok:1,exp:'Mede o tempo pago que n√£o gerou produ√ß√£o (esperas, falhas).'},
        {q:'Uma causa t√≠pica de Waste Time √©:',opts:['Espera por interfer√™ncia ou material','Trabalhar r√°pido demais','Pausa para √°gua'],ok:0,exp:'Equipe parada aguardando libera√ß√£o √© desperd√≠cio puro.'},
        {q:'Waste Time est√° ligado a qual conceito?',opts:['PMBOK','Lean Construction e elimina√ß√£o de desperd√≠cios','Norma NR-10'],ok:1,exp:'Lean foca em criar fluxo e eliminar o que n√£o agrega valor.'},
        {q:'Onde registrar as ocorr√™ncias de perda de tempo?',opts:['Em lugar nenhum','No apontamento/Dashboard semanal','No Facebook'],ok:1,exp:'Para combater, precisamos medir e tipificar as perdas.'},
        {q:'A redu√ß√£o do Waste Time impacta diretamente:',opts:['Aumenta a Produtividade','Aumenta o Custo','Atrasa a obra'],ok:0,exp:'Menos tempo perdido = Mais tempo produzindo.'},
        {q:'Movimenta√ß√£o excessiva de pessoas √© classificada como:',opts:['Exerc√≠cio f√≠sico','Categoria de desperd√≠cio (Waste)','Necess√°rio'],ok:1,exp:'Layout ruim obriga o funcion√°rio a andar em vez de trabalhar.'},
        {q:'Qual a meta ideal para "esperas" na obra?',opts:['10%','Zero espera','50%'],ok:1,exp:'A perfei√ß√£o √© o fluxo cont√≠nuo (embora dif√≠cil, √© o norte).'}
      ],
      // MOD 12: AS-BUILT
      12: [
        {q:'O que o As-Built representa?',opts:['O projeto original','O que foi realmente executado (Como Constru√≠do)','O or√ßamento'],ok:1,exp:'Registra as altera√ß√µes e a realidade final da obra.'},
        {q:'O As-Built deve ser integrado com:',opts:['RH','Engenharia e Controle de Qualidade','Marketing'],ok:1,exp:'Garante que a documenta√ß√£o t√©cnica reflete o campo.'},
        {q:'Qual o prazo ideal para registrar o As-Built?',opts:['No final da obra','Semanalmente ou conforme a execu√ß√£o avan√ßa','Nunca'],ok:1,exp:'Deixar para o final gera esquecimento e perda de informa√ß√µes.'},
        {q:'A falta de As-Built gera risco de:',opts:['Economia','Retrabalho futuro e problemas de manuten√ß√£o','Adiantamento'],ok:1,exp:'Furar um tubo que "n√£o deveria estar ali" √© um cl√°ssico.'},
        {q:'O As-Built ajuda muito em qual fase futura?',opts:['Mobiliza√ß√£o','Comissionamento e Opera√ß√£o','Or√ßamento inicial'],ok:1,exp:'A equipe de startup precisa saber exatamente o que est√° instalado.'},
        {q:'Uma boa pr√°tica para As-Built √©:',opts:['Marca√ß√£o visual em planta (Red lines) por cores','Apenas fotos','Memorizar'],ok:0,exp:'Manter as plantas de campo marcadas (caneta vermelha) atualizadas.'},
        {q:'O resultado final do As-Built √©:',opts:['Um desenho bonito','Documento t√©cnico confi√°vel para o cliente (Data Book)','Lixo'],ok:1,exp:'Faz parte da entrega formal do ativo.'}
      ]
    };

    // ===========================================
    // 2. ESTADO E LOGICA
    // ===========================================

    const STATE_KEY='duoplanning_v7_fixed'; // Mudan√ßa de vers√£o para limpar cache
    let S = {
      name:'', xp:0, completed:[], completedLog:[], 
      weeklyClaimAt:0, confetti:true, sound:true, require70:true,
      theme:'dark', lang:'pt', updatedAt: Date.now()
    };

    // Elementos UI
    const el = (id)=>document.getElementById(id);
    const UI = {
      topBar: el('topBar'), viewLogin: el('viewLogin'), viewDash: el('viewDash'),
      btnGoogle: el('btnGoogle'), btnLocal: el('btnLocal'), inpName: el('inpName'),
      userBadge: el('userBadge'), btnLogout: el('btnLogout'),
      mods: el('mods'), hello: el('hello'), xpText: el('xpText'), xpFill: el('xpFill'),
      legend: el('legend'),
      btnDaily: el('btnDaily'), btnWeekly: el('btnWeekly'), wkStatus: el('wkStatus'),
      quiz: el('quiz'), qText: el('qText'), opts: el('opts'), exp: el('exp'), 
      btnNext: el('btnNext'), qProg: el('qProg'), quizTitle: el('quizTitle'),
      btnCloseQuiz: el('btnCloseQuiz'), toast: el('toast'),
      btnConfig: el('btnConfig'), config: el('config'), btnCloseConfig: el('btnCloseConfig'),
      btnReset: el('btnReset'), cfgConfetti: el('cfgConfetti'), cfgSound: el('cfgSound'), cfgRequire70: el('cfgRequire70'),
      btnRank: el('btnRank'), ranking: el('ranking'), btnCloseRank: el('btnCloseRank'), rankBody: el('rankBody')
    };

    // Fun√ß√µes Core
    function loadState(){
      try {
        const raw = JSON.parse(localStorage.getItem(STATE_KEY));
        if(raw) S = {...S, ...raw};
        S.xp = +S.xp || 0;
      } catch(e){ console.log('Novo usu√°rio ou erro de cache'); }
    }
    
    function saveState(){
      S.updatedAt = Date.now();
      localStorage.setItem(STATE_KEY, JSON.stringify(S));
      if(auth.currentUser) saveCloud();
    }
    
    async function saveCloud(){
      try { await setDoc(doc(db, "users", auth.currentUser.uid), S, {merge:true}); } catch(e){console.error(e);}
    }

    function getLevelInfo(mod){ return LEVELS.find(l=>l.id===mod.level) || LEVELS[0]; }
    
    function isLocked(mod){
      if(mod.level === 'Tecnico') return false; 
      if(mod.level === 'Analista') return !TEC_IDS.every(id => S.completed.includes(id));
      if(mod.level === 'Especialista') {
        const anaIds = [13,14,15,16,17,18,19,20];
        return !anaIds.every(id => S.completed.includes(id));
      }
      return true; 
    }

    // Renderiza√ß√£o Principal
    function render(){
      if(!S.name){
        UI.viewLogin.classList.remove('hidden');
        UI.viewDash.classList.add('hidden');
        UI.topBar.classList.add('hidden');
        return;
      }
      UI.viewLogin.classList.add('hidden');
      UI.viewDash.classList.remove('hidden');
      UI.topBar.classList.remove('hidden');
      
      UI.hello.textContent = `Ol√°, ${S.name.split(' ')[0]}!`;
      UI.userBadge.textContent = auth.currentUser ? '‚òÅÔ∏è Nuvem' : 'üè† Local';
      
      // XP
      const nextXP = 1000; 
      UI.xpText.textContent = `${S.xp} XP`;
      UI.xpFill.style.width = Math.min(100, (S.xp/nextXP)*100) + '%';
      
      let currentLvl = 'T√©cnico';
      if(S.xp > 360) currentLvl = 'Analista';
      if(S.xp > 800) currentLvl = 'Especialista';
      el('userLvlDisplay').textContent = currentLvl;
      el('userLvlDisplay').className = `chip lv-${currentLvl.toLowerCase().substring(0,3)}`;

      // Renderizar Legenda
      UI.legend.innerHTML = LEVELS.map(l=> 
        `<span class="chip" style="color:${l.color};border-color:${l.color}33">${l.icon} ${l.label}</span>`
      ).join('');

      // Renderizar M√≥dulos (O Ponto Cr√≠tico)
      UI.mods.innerHTML = MODULES.map(m => {
        const info = getLevelInfo(m);
        const done = S.completed.includes(m.id);
        const locked = isLocked(m);
        const statusHtml = done ? '<span class="status done">‚úÖ Conclu√≠do</span>' : locked ? '<span class="status lock">üîí Bloqueado</span>' : '<span class="status">‚ñ∂Ô∏è Dispon√≠vel</span>';
        
        let btnHtml = '';
        if(locked) {
          btnHtml = `<button class="ghost" disabled style="font-size:12px">Bloqueado</button>`;
        } else {
          btnHtml = `<button class="primary" onclick="window.startMod(${m.id})" style="background:${info.color}; font-size:13px">Jogar</button>`;
        }
        
        return `
          <div class="card lv lv-${info.id.toLowerCase().substring(0,3)} ${locked?'locked':''}">
            <span class="ribbon"></span>
            ${locked ? '<div class="lock-overlay"><div class="lock-icon">üîí</div></div>' : ''}
            <div class="icon">${m.icon}</div>
            <h4>${m.title}</h4>
            <div class="mod-footer">
              ${statusHtml}
              ${!locked ? btnHtml : ''}
            </div>
          </div>
        `;
      }).join('');

      checkWeekly();
    }

    // ===========================================
    // 3. QUIZ ENGINE
    // ===========================================
    let activeQuiz = null;
    let qIdx = 0;
    let score = 0;
    let isDaily = false;
    let currentModId = 0;

    window.startMod = (id) => {
      const mod = MODULES.find(m=>m.id===id);
      const questions = DB_QUIZ[id];
      
      if(!questions){
        toast("üõ†Ô∏è M√≥dulo em desenvolvimento (Aguardando Bloco 2!)");
        return;
      }

      activeQuiz = sample(questions, 8); 
      qIdx = 0;
      score = 0;
      isDaily = false;
      currentModId = id;
      
      setupQuizUI(mod.title, mod.level);
    };

    UI.btnDaily.onclick = () => {
      const allQ = [];
      Object.values(DB_QUIZ).forEach(arr => allQ.push(...arr));
      if(allQ.length === 0) return;
      
      activeQuiz = sample(allQ, 3);
      qIdx = 0;
      score = 0;
      isDaily = true;
      setupQuizUI("Miss√£o Di√°ria", "Tecnico");
    };

    function setupQuizUI(title, levelId){
      const lvl = LEVELS.find(l=>l.id===levelId) || LEVELS[0];
      UI.quizTitle.textContent = title;
      UI.quiz.style.display = 'flex';
      UI.btnNext.style.background = lvl.color;
      renderQuestion();
    }

    function renderQuestion(){
      if(qIdx >= activeQuiz.length) return finishQuiz();
      
      const Q = activeQuiz[qIdx];
      UI.qText.textContent = Q.q;
      UI.qProg.textContent = `${qIdx+1} / ${activeQuiz.length}`;
      UI.opts.innerHTML = '';
      UI.exp.classList.add('hidden');
      UI.btnNext.classList.add('hidden');

      const idxs = Q.opts.map((_, i) => i);
      shuffle(idxs);
      
      idxs.forEach(i => {
        const btn = document.createElement('div');
        btn.className = 'opt';
        btn.textContent = Q.opts[i];
        btn.onclick = () => checkAnswer(i, Q, btn);
        UI.opts.appendChild(btn);
      });
    }

    function checkAnswer(chosenI, Q, btnElement){
      if(!UI.btnNext.classList.contains('hidden')) return;

      const isCorrect = (chosenI === Q.ok);
      if(isCorrect) {
        score++;
        btnElement.classList.add('correct');
        if(S.confetti) confettiMini();
      } else {
        btnElement.classList.add('wrong');
        const allOpts = UI.opts.children;
        for(let b of allOpts){
          if(b.textContent === Q.opts[Q.ok]) b.classList.add('correct');
        }
      }
      
      UI.exp.textContent = (isCorrect ? "‚úÖ Correto! " : "‚ùå Ops! ") + Q.exp;
      UI.exp.classList.remove('hidden');
      UI.btnNext.classList.remove('hidden');
    }

    UI.btnNext.onclick = () => {
      qIdx++;
      renderQuestion();
    };

    function finishQuiz(){
      const total = activeQuiz.length;
      const pct = (score/total)*100;
      const req = S.require70 ? 70 : 0;
      const passed = isDaily ? (score===total) : (pct >= req);
      
      UI.qText.textContent = passed ? "üéâ Parab√©ns!" : "Tente novamente...";
      UI.opts.innerHTML = `
        <div style="text-align:center; font-size:40px; margin:20px">${passed?'üèÜ':'üìö'}</div>
        <div style="text-align:center; margin-bottom:10px">Voc√™ acertou ${score} de ${total} (${Math.round(pct)}%)</div>
        ${!passed && S.require70 ? '<div style="text-align:center;font-size:12px;color:var(--danger)">Necess√°rio 70% para aprovar.</div>' : ''}
      `;
      UI.exp.classList.add('hidden');
      UI.btnNext.textContent = "Fechar";
      UI.btnNext.classList.remove('hidden');
      UI.btnNext.onclick = () => {
        UI.quiz.style.display='none';
        UI.btnNext.textContent = "Confirmar"; 
        if(passed) processWin();
      };

      if(passed && S.sound) playSound();
      if(passed && S.confetti) confettiBurst();
    }

    function processWin(){
      if(isDaily){
        S.xp += 20;
        toast("+20 XP (Di√°ria)");
      } else {
        if(!S.completed.includes(currentModId)){
          S.completed.push(currentModId);
          const mod = MODULES.find(m=>m.id===currentModId);
          const lvl = getLevelInfo(mod);
          S.xp += lvl.xp;
          S.completedLog.push({id:currentModId, ts:Date.now()});
          toast(`+${lvl.xp} XP - M√≥dulo Conclu√≠do!`);
        } else {
          toast("M√≥dulo j√° conclu√≠do (sem XP extra).");
        }
      }
      saveState();
      render();
    }

    // Utilit√°rios
    function toast(msg){
      UI.toast.textContent = msg;
      UI.toast.style.display='block';
      UI.toast.style.animation='slideUp 0.3s forwards';
      setTimeout(()=>UI.toast.style.display='none', 2500);
    }
    function sample(arr, n){
      if(!arr) return [];
      const s = [...arr];
      shuffle(s);
      return s.slice(0, n);
    }
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function checkWeekly(){
      const oneWeek = 604800000;
      const now = Date.now();
      const recent = S.completedLog.filter(x => (now - x.ts) < oneWeek).length;
      
      if(recent >= 3 && (now - S.weeklyClaimAt > oneWeek)){
        UI.wkStatus.textContent = "‚úÖ Conclu√≠da! Resgate agora.";
        UI.btnWeekly.disabled = false;
        UI.btnWeekly.onclick = () => {
          S.xp += 100;
          S.weeklyClaimAt = now;
          saveState();
          render();
          toast("+100 XP Semanal!");
          confettiBurst();
        }
      } else {
        UI.wkStatus.textContent = `Progresso: ${recent}/3 m√≥dulos esta semana`;
        UI.btnWeekly.disabled = true;
      }
    }

    // Efeitos
    function confettiMini() { 
      const colors = ['#58cc02','#3aa0ff','#f2b01c'];
      for(let i=0; i<15; i++){
        const el = document.createElement('div');
        el.style.cssText = `position:fixed;left:50%;top:50%;width:6px;height:6px;background:${colors[i%3]};pointer-events:none;z-index:999`;
        document.body.append(el);
        const angle = Math.random()*Math.PI*2;
        const anim = el.animate([
          {transform:'translate(0,0)'},
          {transform:`translate(${Math.cos(angle)*100}px, ${Math.sin(angle)*100}px)`, opacity:0}
        ], {duration: 600, easing:'ease-out'});
        anim.onfinish = ()=>el.remove();
      }
    }
    function confettiBurst() {
      for(let k=0; k<30; k++) setTimeout(confettiMini, k*20);
    }
    function playSound(){
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        osc.type='sine'; osc.frequency.value=500;
        osc.start(); 
        osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime+0.1);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.3);
        osc.stop(ctx.currentTime+0.3);
      } catch(e){}
    }

    // Inicializa√ß√£o
    UI.btnLocal.onclick = () => { 
      if(UI.inpName.value.trim()) { S.name=UI.inpName.value; saveState(); render(); } 
    };
    UI.btnGoogle.onclick = async () => {
      try { 
        const res = await signInWithPopup(auth, provider);
        if(!S.name) S.name = res.user.displayName;
      } catch(e){ console.error(e); toast("Erro no login"); }
    };
    UI.btnLogout.onclick = async () => {
      await signOut(auth);
      localStorage.removeItem(STATE_KEY);
      location.reload();
    };
    
    UI.btnConfig.onclick = () => UI.config.style.display = 'flex';
    UI.btnCloseConfig.onclick = () => UI.config.style.display = 'none';
    UI.btnRank.onclick = () => { UI.ranking.style.display = 'flex'; loadRanking(); };
    UI.btnCloseRank.onclick = () => UI.ranking.style.display = 'none';
    UI.btnCloseQuiz.onclick = () => UI.quiz.style.display = 'none';

    UI.cfgConfetti.onchange = (e) => { S.confetti=e.target.checked; saveState(); };
    UI.cfgSound.onchange = (e) => { S.sound=e.target.checked; saveState(); };
    UI.cfgRequire70.onchange = (e) => { S.require70=e.target.checked; saveState(); };
    UI.btnReset.onclick = () => { if(confirm("Zerar todo progresso?")){ S.xp=0; S.completed=[]; saveState(); location.reload(); }};

    async function loadRanking(){
      UI.rankBody.innerHTML = 'Carregando...';
      try {
        const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(10));
        const snap = await getDocs(q);
        UI.rankBody.innerHTML = snap.docs.map((d,i) => {
          const u = d.data();
          return `<div class="row" style="justify-content:space-between; border-bottom:1px solid #333; padding:8px 0">
            <span>${i+1}. ${u.name.substring(0,15)}</span>
            <span style="color:var(--accent)">${u.xp} XP</span>
          </div>`;
        }).join('');
      } catch(e) { UI.rankBody.textContent = "Erro ao carregar ranking."; }
    }

    onAuthStateChanged(auth, async (user) => {
      if(user){
        const docRef = doc(db, "users", user.uid);
        const snap = await getDoc(docRef);
        if(snap.exists()){
          const cloud = snap.data();
          if(cloud.updatedAt > S.updatedAt) S = {...S, ...cloud};
        }
        onSnapshot(docRef, (s) => {
           if(s.exists() && s.data().updatedAt > S.updatedAt) { 
             S = {...S, ...s.data()}; 
             render(); 
           }
        });
      }
      render();
    });

    loadState();
    render();

    UI.cfgConfetti.checked = S.confetti;
    UI.cfgSound.checked = S.sound;
    UI.cfgRequire70.checked = S.require70;

  </script>
</body>
</html>