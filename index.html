<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Duoplanning ‚Äî v4 Final (1‚Äì40)</title>
  <meta name="color-scheme" content="dark light">
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- Victory SFX -->
  <audio id="audioWin" preload="auto">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_0b6ce6218f.mp3?filename=success-fanfare-trumpets-6185.mp3" type="audio/mpeg">
  </audio>
  <style>
    :root{
      --bg:#0f1115; --text:#e9eef7; --muted:#a7b1c2; --primary:#3aa0ff; --accent:#ffb020;
      --success:#27c081; --danger:#ff5d5d; --panel:#161c24; --card:#141a22; --border:#273046;
      --locked:#6b7280;
    }
    /* Light theme overrides */
    :root[data-theme="light"]{
      --bg:#f7f9fc; --text:#0f1115; --muted:#5b6575; --primary:#2563eb; --accent:#ffb020;
      --success:#16a34a; --danger:#dc2626; --panel:#ffffff; --card:#ffffff; --border:#d5dbe7;
      --locked:#9aa3b2;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1120px;margin:0 auto;padding:24px}
    h1,h2,h3{margin:0 0 12px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.10)}
    .grid{display:grid;gap:12px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#111720;color:var(--text);cursor:pointer;transition:transform .15s ease,opacity .15s ease}
    :root[data-theme="light"] .btn{background:#f3f6fb}
    .btn.primary{background:var(--primary);color:#05131e;border:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.ghost{background:transparent}
    .meta{color:var(--muted);font-size:13px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#05131e;background:var(--accent);padding:4px 8px;border-radius:999px}
    .xpbar{height:10px;background:#0b111a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    :root[data-theme="light"] .xpbar{background:#e7edf7}
    .xpbar>i{display:block;height:100%;background:linear-gradient(90deg,var(--success),#6ee7b7)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .mod{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#101723}
    :root[data-theme="light"] .mod{background:#f3f6fb}
    .mod .left{display:flex;align-items:center;gap:10px}
    .mod .lvl{font-size:20px}
    .lock{opacity:.85;color:var(--locked)}
    .hidden{display:none !important}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    select, input[type="text"]{background:#0f1520;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
    :root[data-theme="light"] select, :root[data-theme="light"] input[type="text"]{background:#ffffff}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#0c131d}
    :root[data-theme="light"] .pill{background:#ffffff}
    .toast{position:fixed;inset:auto 16px 16px auto;background:#0c1a13;border:1px solid #124c2e;color:#b9f6ca;padding:12px 14px;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.35);display:none}
    .kpi{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .kpi .chip{background:#0c131d;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    :root[data-theme="light"] .kpi .chip{background:#ffffff}
    /* Overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:18px;animation:fadeIn .2s ease;z-index:20}
    .overlay .sheet{max-width:860px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 24px 64px rgba(0,0,0,.5);overflow:hidden}
    .sheet .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:#0f1722}
    :root[data-theme="light"] .sheet .head{background:#f1f5fb}
    .sheet .body{padding:16px}
    .q{font-size:17px;margin-bottom:10px}
    .opts{display:grid;gap:10px}
    .opt{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0d1420;cursor:pointer;transition:transform .1s ease, background .2s ease, border-color .2s ease}
    :root[data-theme="light"] .opt{background:#ffffff}
    .opt.correct{border-color:#1f9d6b;background:#0b1712}
    .opt.wrong{border-color:#8b1d30;background:#190f12}
    .exp{border-left:3px solid var(--accent);padding:8px 12px;margin-top:10px;background:#0f1622}
    :root[data-theme="light"] .exp{background:#f8fafc}
    .foot{display:flex;align-items:center;justify-content:space-between;margin-top:14px}
    /* Fade animation between views */
    .view{opacity:0;transform:translateY(8px);transition:opacity .25s ease, transform .25s ease}
    .view.show{opacity:1;transform:translateY(0)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Top bar -->
  <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:16px">
    <div class="row" style="align-items:center">
      <h1>Duoplanning</h1>
      <span class="badge" style="margin-left:10px">v4 ‚Äî 40 m√≥dulos</span>
    </div>
    <div class="row">
      <button id="btnConfig" class="btn ghost">‚öôÔ∏è <span class="meta" style="font-size:14px">Configura√ß√µes</span></button>
      <button id="btnLogout" class="btn ghost hidden">Sair</button>
    </div>
  </div>

  <!-- Login -->
  <section id="viewLogin" class="panel view show">
    <h2 data-i18n="login_title">Entrar</h2>
    <p class="meta" data-i18n="login_tip">Digite seu nome para come√ßar sua trilha.</p>
    <div class="row">
      <input id="inpName" placeholder="Seu nome" style="min-width:260px" />
      <button id="btnLogin" class="btn primary" data-i18n="start">Come√ßar</button>
    </div>
    <div class="meta" style="margin-top:10px" data-i18n="login_hint">
      Voc√™ come√ßar√° no n√≠vel T√©cnico e vai desbloqueando os demais por XP.
    </div>
  </section>

  <!-- Dashboard -->
  <section id="viewDash" class="hidden view">
    <div class="grid cols-3">
      <div class="panel">
        <h3 id="hello">Ol√°, Jogador</h3>
        <div class="meta" id="roleMini">T√©cnico ‚Äî Domina o b√°sico do LPS</div>
        <div style="margin:10px 0 6px;display:flex;justify-content:space-between;align-items:center">
          <div class="meta"><span data-i18n="xp">XP</span>: <b id="xpNow">0</b> / <span id="xpGoal">1000</span></div>
          <div class="pill"><span id="streak">üî• 0</span><span class="meta" data-i18n="streak">streak</span></div>
        </div>
        <div class="xpbar"><i id="xpBar" style="width:0%"></i></div>
        <div class="kpi" style="margin-top:12px">
          <div class="chip">‚ö° <b id="energy">3</b> <span class="meta" data-i18n="energy">energia</span></div>
          <div class="chip">üèÜ <span data-i18n="local_rank">Rank local</span>: <b id="rankMe">#1</b></div>
        </div>
      </div>

      <div class="panel">
        <h3 data-i18n="missions_hdr">Miss√µes</h3>
        <div class="row">
          <div class="pill" id="missionDailyPill">üéØ <b data-i18n="daily">Dia</b>: <span data-i18n="daily_desc">Refa√ßa um quiz 100% (+20XP)</span></div>
          <div class="pill" id="missionWeekPill">üìÖ <b data-i18n="week">Semana</b>: <span data-i18n="week_desc">Concluir 3 m√≥dulos (+100XP)</span> <span class="meta" id="weekProg">(0/3)</span></div>
        </div>
        <div class="meta" style="margin-top:10px" data-i18n="week_progress">Progresso semanal:</div>
        <div class="xpbar"><i id="weekBar" style="width:0%"></i></div>
      </div>

      <div class="panel">
        <h3 data-i18n="rank_hdr">Ranking (local)</h3>
        <div id="rankList" class="grid"></div>
      </div>
    </div>

    <div class="panel" style="margin-top:14px">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h3 data-i18n="modules_hdr">M√≥dulos</h3>
        <div class="pill" id="levelNowPill">üë∑ T√©cnico</div>
      </div>
      <div class="meta" style="margin:6px 0" data-i18n="modules_hint">M√≥dulos de outros n√≠veis aparecem com cadeado üîí. Ganhe XP para desbloquear!</div>
      <div id="mods" class="grid cols-4" style="margin-top:12px"></div>
    </div>
  </section>

</div>

<!-- Quiz Overlay -->
<div id="quizOverlay" class="overlay">
  <div class="sheet">
    <div class="head">
      <div id="quizTitle">Quiz</div>
      <button id="btnCloseQuiz" class="btn ghost" data-i18n="close">Fechar</button>
    </div>
    <div class="body">
      <div class="q" id="qText">Pergunta</div>
      <div class="opts" id="qOpts"></div>
      <div id="qExplain" class="exp hidden"></div>
      <div class="foot">
        <div class="meta"><span id="qNum">1</span>/10</div>
        <button id="btnNext" class="btn primary" data-i18n="next">Avan√ßar</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Overlay -->
<div id="cfgOverlay" class="overlay">
  <div class="sheet">
    <div class="head">
      <div>‚öôÔ∏è <b data-i18n="settings">Configura√ß√µes</b></div>
      <button id="btnCloseCfg" class="btn ghost" data-i18n="close">Fechar</button>
    </div>
    <div class="body">
      <div class="grid cols-3">
        <div class="panel">
          <h3 data-i18n="appearance">Apar√™ncia</h3>
          <div class="row" style="margin-top:8px">
            <label class="meta" for="selTheme" data-i18n="theme">Tema</label>
            <select id="selTheme">
              <option value="dark" data-i18n="theme_dark">Escuro</option>
              <option value="light" data-i18n="theme_light">Claro</option>
              <option value="auto" data-i18n="theme_auto">Autom√°tico</option>
            </select>
          </div>
        </div>
        <div class="panel">
          <h3 data-i18n="language">Idioma</h3>
          <div class="row" style="margin-top:8px">
            <select id="langSel2">
              <option value="pt">Portugu√™s</option>
              <option value="en">English</option>
              <option value="es">Espa√±ol</option>
            </select>
          </div>
        </div>
        <div class="panel">
          <h3 data-i18n="effects">Efeitos</h3>
          <div class="row" style="margin-top:8px">
            <label><input type="checkbox" id="chkSound" /> <span class="meta" data-i18n="sound">Som de vit√≥ria</span></label>
          </div>
          <div class="row">
            <label><input type="checkbox" id="chkConfetti" /> <span class="meta" data-i18n="confetti">Confete</span></label>
          </div>
        </div>
      </div>
      <div class="panel" style="margin-top:12px">
        <h3 data-i18n="danger_zone">Zona de risco</h3>
        <button id="btnReset" class="btn" style="margin-top:8px;background:#1f2937" data-i18n="reset">Resetar progresso</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast">Salvo</div>

<script>
// ====== I18N ======
const I18N = {
  pt: {
    login_title:"Entrar",
    login_tip:"Digite seu nome para come√ßar sua trilha.",
    login_hint:"Voc√™ come√ßar√° no n√≠vel T√©cnico e vai desbloqueando os demais por XP.",
    start:"Come√ßar",
    xp:"XP",
    streak:"streak",
    energy:"energia",
    local_rank:"Rank local",
    missions_hdr:"Miss√µes",
    daily:"Dia",
    daily_desc:"Refa√ßa um quiz 100% (+20XP)",
    week:"Semana",
    week_desc:"Concluir 3 m√≥dulos (+100XP)",
    week_progress:"Progresso semanal:",
    rank_hdr:"Ranking (local)",
    modules_hdr:"M√≥dulos",
    modules_hint:"M√≥dulos de outros n√≠veis aparecem com cadeado üîí. Ganhe XP para desbloquear!",
    close:"Fechar",
    next:"Avan√ßar",
    welcome:"Bem-vindo(a)!",
    saved:"Salvo",
    module_done:"M√≥dulo #{id} conclu√≠do: {score}/10",
    mission_daily_done:"Miss√£o do Dia conclu√≠da! +20XP",
    mission_week_done:"Miss√£o da Semana conclu√≠da! +100XP",
    settings:"Configura√ß√µes",
    appearance:"Apar√™ncia",
    theme:"Tema",
    theme_dark:"Escuro",
    theme_light:"Claro",
    theme_auto:"Autom√°tico",
    language:"Idioma",
    effects:"Efeitos",
    sound:"Som de vit√≥ria",
    confetti:"Confete",
    danger_zone:"Zona de risco",
    reset:"Resetar progresso",
  },
  en: {
    login_title:"Sign in",
    login_tip:"Type your name to start your path.",
    login_hint:"You will start at the Technician level and unlock the others with XP.",
    start:"Start",
    xp:"XP",
    streak:"streak",
    energy:"energy",
    local_rank:"Local rank",
    missions_hdr:"Missions",
    daily:"Daily",
    daily_desc:"Retake a quiz with 100% (+20XP)",
    week:"Weekly",
    week_desc:"Complete 3 modules (+100XP)",
    week_progress:"Weekly progress:",
    rank_hdr:"Ranking (local)",
    modules_hdr:"Modules",
    modules_hint:"Modules from other levels show a üîí. Earn XP to unlock!",
    close:"Close",
    next:"Next",
    welcome:"Welcome!",
    saved:"Saved",
    module_done:"Module #{id} finished: {score}/10",
    mission_daily_done:"Daily Mission completed! +20XP",
    mission_week_done:"Weekly Mission completed! +100XP",
    settings:"Settings",
    appearance:"Appearance",
    theme:"Theme",
    theme_dark:"Dark",
    theme_light:"Light",
    theme_auto:"Auto",
    language:"Language",
    effects:"Effects",
    sound:"Victory sound",
    confetti:"Confetti",
    danger_zone:"Danger zone",
    reset:"Reset progress",
  },
  es: {
    login_title:"Iniciar sesi√≥n",
    login_tip:"Escribe tu nombre para comenzar tu ruta.",
    login_hint:"Comenzar√°s en el nivel T√©cnico y desbloquear√°s los dem√°s con XP.",
    start:"Comenzar",
    xp:"XP",
    streak:"racha",
    energy:"energ√≠a",
    local_rank:"Ranking local",
    missions_hdr:"Misiones",
    daily:"D√≠a",
    daily_desc:"Repite un quiz con 100% (+20XP)",
    week:"Semana",
    week_desc:"Completar 3 m√≥dulos (+100XP)",
    week_progress:"Progreso semanal:",
    rank_hdr:"Ranking (local)",
    modules_hdr:"M√≥dulos",
    modules_hint:"Los m√≥dulos de otros niveles se muestran con candado üîí. ¬°Gana XP para desbloquearlos!",
    close:"Cerrar",
    next:"Siguiente",
    welcome:"¬°Bienvenido(a)!",
    saved:"Guardado",
    module_done:"M√≥dulo #{id} completado: {score}/10",
    mission_daily_done:"¬°Misi√≥n diaria completada! +20XP",
    mission_week_done:"¬°Misi√≥n semanal completada! +100XP",
    settings:"Configuraci√≥n",
    appearance:"Apariencia",
    theme:"Tema",
    theme_dark:"Oscuro",
    theme_light:"Claro",
    theme_auto:"Autom√°tico",
    language:"Idioma",
    effects:"Efectos",
    sound:"Sonido de victoria",
    confetti:"Confeti",
    danger_zone:"Zona de riesgo",
    reset:"Restablecer progreso",
  }
};
let lang = localStorage.getItem("duoplanning.lang") || "pt";
function t(key, vars={}){
  const dict = I18N[lang] || I18N.pt;
  let s = dict[key] || key;
  Object.entries(vars).forEach(([k,v])=>{ s = s.replaceAll("{"+k+"}", v); });
  return s;
}
function applyI18n() {
  const dict = I18N[lang] || I18N.pt;
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (dict[key]) el.textContent = dict[key];
  });
  document.documentElement.lang = lang === "pt" ? "pt-BR" : (lang === "es" ? "es-ES" : "en-US");
  const ls2 = document.getElementById("langSel2");
  if (ls2) ls2.value = lang;
}

// ====== SETTINGS ======
const SETTINGS_KEY = "duoplanning.v4.settings";
let Settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "null") || {
  theme: "dark", // dark | light | auto
  sound: true,
  confetti: true,
};
function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(Settings)); }
function applyTheme(){
  let theme = Settings.theme;
  if (theme === "auto"){
    const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
    theme = prefersLight ? "light" : "dark";
  }
  document.documentElement.setAttribute("data-theme", theme === "light" ? "light" : "dark");
}

// ====== DATA MODEL ======
const LEVELS = [
  { id:"Tecnico", name:"T√©cnico", icon:"üë∑‚Äç‚ôÇÔ∏è", minXP:0, nextXP:1000, desc:"Domina o b√°sico do LPS" },
  { id:"Analista", name:"Analista", icon:"üë®‚Äçüíª", minXP:1000, nextXP:3000, desc:"Organiza cronogramas e indicadores" },
  { id:"Especialista", name:"Especialista", icon:"üë®‚Äçüîß", minXP:3000, nextXP:6000, desc:"Integra Engenharia e Obra" },
  { id:"Gerente", name:"Gerente/Diretor", icon:"üëî", minXP:6000, nextXP:10000, desc:"Lidera com Lean e Performance" },
  { id:"Visionario", name:"Vision√°rio", icon:"üîÆ", minXP:10000, nextXP:Infinity, desc:"Inova com IA, BIM e 5D" }
];

const XP_PER_LEVEL = { Tecnico:30, Analista:40, Especialista:50, Gerente:60, Visionario:80 };

const MODULES = [
  ...Array.from({length:12},(_,i)=>({id:i+1, nivel:'T√©cnico', titulo:`M√≥dulo ${i+1}`})),
  ...Array.from({length:10},(_,i)=>({id:13+i, nivel:'Analista', titulo:`M√≥dulo ${13+i}`})),
  ...Array.from({length:10},(_,i)=>({id:23+i, nivel:'Especialista', titulo:`M√≥dulo ${23+i}`})),
  ...Array.from({length:6},(_,i)=>({id:33+i, nivel:'Gerente/Diretor', titulo:`M√≥dulo ${33+i}`})),
  {id:39, nivel:'Vision√°rio', titulo:'M√≥dulo 39'},
  {id:40, nivel:'Vision√°rio', titulo:'M√≥dulo 40'},
];

const QUIZZES = {};
QUIZZES[1] = [
  { q: "Qual √© o principal objetivo da EAP?", opts: ["Estruturar o escopo em partes control√°veis", "Listar materiais", "Criar √≠ndices de produtividade"], ok: 0, exp: "A EAP quebra o escopo em pacotes gerenci√°veis." },
  { q: "No AWP, o que representa o CWP?", opts: ["Construction Work Package", "Contract Work Package", "Cost Work Package"], ok: 0, exp: "CWP = pacote de trabalho de constru√ß√£o." },
  { type: "order", q: "Qual √© a sequ√™ncia correta entre os pacotes AWP?", items: ["EWP", "CWP", "IWP"], correctOrder: ["EWP", "CWP", "IWP"], exp: "Engenharia ‚Üí Constru√ß√£o ‚Üí Instala√ß√£o." },
  { q: "Quem normalmente detalha o IWP?", opts: ["Planejamento + Supervis√£o de Campo", "Financeiro", "Seguran√ßa"], ok: 0, exp: "Planejamento com a supervis√£o definem escopo execut√°vel." },
  { q: "A EAP contribui para:", opts: ["Rastreabilidade e controle", "Aumentar burocracia", "Dificultar medi√ß√µes"], ok: 0, exp: "Padroniza controle e integra com √≠ndices/custos." },
  { q: "At√© que n√≠vel a EAP deve ir?", opts: ["At√© suportar controle de prazo e custo", "Sempre at√© 7 n√≠veis", "Apenas 2 n√≠veis"], ok: 0, exp: "Profundidade suficiente para gest√£o eficaz." },
  { q: "Benef√≠cio de libera√ß√£o progressiva no AWP:", opts: ["Fluxo cont√≠nuo de frentes", "Mais retrabalho", "Menos visibilidade"], ok: 0, exp: "Libera √°reas/zonas por marcos de engenharia/suprimentos." },
  { q: "Quando o AWP deve come√ßar a ser aplicado?", opts: ["No planejamento da engenharia", "Somente na obra", "Ap√≥s o comissionamento"], ok: 0, exp: "Come√ßa na engenharia para orquestrar o fluxo fim-a-fim." },
  { q: "O IWP deve conter:", opts: ["Instru√ß√µes, materiais, desenhos e requisitos de seguran√ßa", "Apenas custo", "Somente cronograma"], ok: 0, exp: "Conte√∫do completo para execu√ß√£o segura e rastre√°vel." },
  { q: "Uma boa EAP facilita a integra√ß√£o com:", opts: ["Cronograma, √≠ndices e medi√ß√µes", "Somente planilhas financeiras", "Apenas reuni√µes"], ok: 0, exp: "Conecta planejamento, custos e f√≠sico." }
];
QUIZZES[2] = [
  { q: "O que representa uma rela√ß√£o FS?", opts: ["T√©rmino‚ÄìIn√≠cio", "In√≠cio‚ÄìIn√≠cio", "T√©rmino‚ÄìT√©rmino"], ok: 0, exp: "Sucessora inicia ap√≥s t√©rmino da predecessora." },
  { q: "Boa pr√°tica ao atualizar o cronograma:", opts: ["Registrar % f√≠sico e datas reais", "Usar datas planejadas como reais", "Ignorar pend√™ncias"], ok: 0, exp: "Sem registro real, an√°lises ficam inv√°lidas." },
  { type: "order", q: "PR√ÅTICA ‚Äî Ordene a sequ√™ncia correta de montagem el√©trica:", items: ["Instala√ß√£o do eletroduto", "Lan√ßamento de cabos", "Liga√ß√£o no CCM", "Testes el√©tricos"], correctOrder: ["Instala√ß√£o do eletroduto", "Lan√ßamento de cabos", "Liga√ß√£o no CCM", "Testes el√©tricos"], exp: "Infraestrutura ‚Üí Cabo ‚Üí Liga√ß√£o ‚Üí Testes." },
  { q: "Rela√ß√£o SS significa:", opts: ["In√≠cio‚ÄìIn√≠cio", "T√©rmino‚ÄìIn√≠cio", "T√©rmino‚ÄìT√©rmino"], ok: 0, exp: "Atividades podem iniciar em paralelo." },
  { q: "Rela√ß√£o FF significa:", opts: ["T√©rmino‚ÄìT√©rmino", "In√≠cio‚ÄìT√©rmino", "In√≠cio‚ÄìIn√≠cio"], ok: 0, exp: "Devem terminar pr√≥ximas no tempo." },
  { q: "Folga total zero indica:", opts: ["Atividade cr√≠tica", "Atividade conclu√≠da", "Atividade livre"], ok: 0, exp: "Atraso impacta o prazo do projeto." },
  { q: "O cronograma base √©:", opts: ["Linha de refer√™ncia para controle", "Relat√≥rio mensal", "Plano de custos"], ok: 0, exp: "Usado para medir varia√ß√µes." },
  { q: "Respons√°vel pela atualiza√ß√£o:", opts: ["Planejamento com feedback de campo", "Apenas diretoria", "Apenas seguran√ßa"], ok: 0, exp: "Integra dados reais com a linha de base." },
  { q: "O cronograma deve refletir:", opts: ["Realidade f√≠sica e l√≥gica de execu√ß√£o", "Prefer√™ncias pessoais", "Apenas metas financeiras"], ok: 0, exp: "Coer√™ncia l√≥gica √© essencial." },
  { q: "Atraso numa predecessora FS:", opts: ["Propaga atraso para sucessoras", "N√£o tem efeito", "Adianta sucessoras"], ok: 0, exp: "Impacto cascata em cadeias FS." }
];
QUIZZES[13] = [
  { q:"O objetivo do Rundown √©:", opts:["Comparar avan√ßo semanal planejado x realizado","Registrar custos","Organizar equipes"], ok:0, exp:"Mostra ritmo semanal e alimenta a Curva S." },
  { q:"Base de c√°lculo da Curva S:", opts:["Pesos f√≠sicos (HH, ton, m)","Somente custo","Horas extras"], ok:0, exp:"Pesos f√≠sicos por atividade." },
  { type:"calc", q:"PR√ÅTICA ‚Äî Real 35% e Plano 40%: desvio =", answer:-5, tolerance:0.5, unit:"%", exp:"Desvio = Real ‚àí Plano = ‚àí5 p.p. (atraso)." },
  { q:"Frequ√™ncia t√≠pica do Rundown:", opts:["Semanal","Mensal","Anual"], ok:0, exp:"Semanal para rea√ß√£o r√°pida." },
  { q:"Vantagem da Curva S:", opts:["Visualizar tend√™ncias e desvios","Calcular HH/dia","Organizar contratos"], ok:0, exp:"Evidencia ader√™ncia ao plano." },
  { type:"calc", q:"Se na semana o Plano=8% e o Real=10%, varia√ß√£o semanal =", answer:2, tolerance:0.2, unit:"p.p.", exp:"10 ‚àí 8 = +2 p.p. (adiantado)." },
  { q:"Para Curva S confi√°vel, √© essencial:", opts:["Crit√©rios de medi√ß√£o claros","Somente horas apontadas","Apenas quantidade de equipes"], ok:0, exp:"Defina pesos, marcos e periodicidade." },
  { type:"text", q:"PR√ÅTICA ‚Äî Diga um motivo t√≠pico para desvio negativo:", answerText:["falta de material","restri√ß√£o","atraso de projeto","acesso","gargalo"], exp:"Restri√ß√£o n√£o tratada √© causa comum." },
  { type:"order", q:"Ordem l√≥gica de leitura:", items:["Rundown semanal","Curva S acumulada","Plano de a√ß√£o"], correctOrder:["Rundown semanal","Curva S acumulada","Plano de a√ß√£o"], exp:"Ritmo ‚Üí tend√™ncia ‚Üí a√ß√£o." },
  { q:"Indicador derivado √∫til:", opts:["Desvio acumulado p.p.","N¬∫ de e-mails","Horas de reuni√£o"], ok:0, exp:"Mostra magnitude do atraso/adianto." }
];

const QUIZ_FALLBACK = [
  { q:"Pergunta gen√©rica 1", opts:["A","B","C"], ok:0, exp:"Explica√ß√£o." },
  { q:"Pergunta gen√©rica 2", opts:["A","B","C"], ok:1, exp:"Explica√ß√£o." },
  { q:"Pergunta gen√©rica 3", opts:["A","B","C"], ok:2, exp:"Explica√ß√£o." },
  { q:"Pergunta gen√©rica 4", opts:["A","B","C"], ok:0, exp:"Explica√ß√£o." },
  { q:"Pergunta gen√©rica 5", opts:["A","B","C"], ok:1, exp:"Explica√ß√£o." },
  { q:"Pergunta gen√©rica 6", opts:["A","B","C"], ok:0, exp:"Explica√ß√£o." },
  { q:"Pergunta gen√©rica 7", opts:["A","B","C"], ok:2, exp:"Explica√ß√£o." },
  { q:"Pergunta gen√©rica 8", opts:["A","B","C"], ok:1, exp:"Explica√ß√£o." },
  { q:"Pergunta gen√©rica 9", opts:["A","B","C"], ok:2, exp:"Explica√ß√£o." },
  { q:"Pergunta gen√©rica 10", opts:["A","B","C"], ok:0, exp:"Explica√ß√£o." },
];

// ====== STATE ======
const STATE_KEY = "duoplanning.v4.state";
let S = JSON.parse(localStorage.getItem(STATE_KEY) || "null") || {
  name:"",
  xp:0,
  energy:3,
  levelId:"Tecnico",
  streak:0,
  lastLoginDay:"",
  cleared: {},
  week: { startIso:"", modulesDone:0 },
  dailyDoneOn:"",
  rank: [{name:"Voc√™", xp:0},{name:"Alice", xp:560},{name:"Bruno", xp:320}],
};
function save(){ localStorage.setItem(STATE_KEY, JSON.stringify(S)); }

// ====== HELPERS ======
function todayKey(){
  const d = new Date();
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
}
function mondayOfThisWeekISO(){
  const d = new Date();
  const day = d.getDay();
  const diff = (day===0 ? -6 : 1 - day);
  const m = new Date(d);
  m.setDate(d.getDate()+diff);
  return m.toISOString().slice(0,10);
}
function levelById(id){ return LEVELS.find(x=>x.id===id) || LEVELS[0]; }
function currentLevel(){
  let L = LEVELS[0];
  for(const lv of LEVELS){ if(S.xp >= lv.minXP) L = lv; }
  S.levelId = L.id; return L;
}
function addXP(v){
  S.xp += v;
  toast(`+${v} ${t("xp")}`);
  if (Settings.sound){
    try{ document.getElementById("audioWin").play().catch(()=>{}); }catch(e){}
  }
  if (Settings.confetti){
    confetti({particleCount:120, spread:65, origin:{ y: .6 }});
  }
  renderDash();
  save();
}
function toast(msg){
  const tEl = document.getElementById("toast");
  tEl.textContent = msg; tEl.style.display = "block";
  setTimeout(()=>{ tEl.style.display="none"; }, 1800);
}

// ====== RENDER ======
function renderDash(){
  const L = currentLevel();
  document.getElementById("hello").textContent = `${lang==="en"?"Hello":"Ol√°"}, ${S.name||"Jogador"}`;
  document.getElementById("roleMini").textContent = `${L.name} ‚Äî ${L.desc}`;
  document.getElementById("levelNowPill").textContent = `${L.icon} ${L.name}`;
  document.getElementById("xpNow").textContent = S.xp;
  document.getElementById("xpGoal").textContent = isFinite(L.nextXP) ? L.nextXP : "‚àû";
  const pct = isFinite(L.nextXP) ? Math.max(0, Math.min(100, 100*(S.xp-L.minXP)/(L.nextXP-L.minXP))) : 100;
  document.getElementById("xpBar").style.width = pct + "%";
  document.getElementById("streak").textContent = `üî• ${S.streak}`;
  document.getElementById("energy").textContent = S.energy;

  const mondayIso = mondayOfThisWeekISO();
  if (S.week.startIso !== mondayIso){ S.week.startIso = mondayIso; S.week.modulesDone = 0; save(); }
  document.getElementById("weekProg").textContent = `(${S.week.modulesDone}/3)`;
  document.getElementById("weekBar").style.width = `${Math.min(100, (S.week.modulesDone/3)*100)}%`;

  const mods = document.getElementById("mods");
  mods.innerHTML = "";
  MODULES.forEach(m=>{
    const locked = (m.nivel !== L.name);
    const score = S.cleared[m.id] || 0;
    const icon = (m.nivel==='T√©cnico'?'üë∑': m.nivel==='Analista'?'üë®‚Äçüíª': m.nivel==='Especialista'?'üë®‚Äçüîß': m.nivel==='Gerente/Diretor'?'üëî':'üîÆ');
    const el = document.createElement("div");
    el.className = "mod";
    el.innerHTML = `
      <div class="left">
        <div class="lvl">${icon}</div>
        <div>
          <div><b>${m.titulo}</b> <span class="meta">#${m.id} ¬∑ ${m.nivel}</span></div>
          <div class="meta">${locked?'<span class="lock">üîí '+(lang==='en'?'Locked': (lang==='es'?'Bloqueado':'bloqueado'))+'</span>': (score? (lang==='en'?'Best':'Melhor')+`: ${score}/10` : (lang==='en'?'Not started':'Ainda n√£o iniciado'))}</div>
        </div>
      </div>
      <div>
        ${score?`<span class="meta">${lang==='en'?'best:':'melhor:'} ${score}/10</span>`:""}
        <button class="btn" ${locked?'disabled':''} data-mod="${m.id}">${locked?'üîí': '‚ñ∂Ô∏è ' + (lang==='en'?'Start':'Iniciar')}</button>
      </div>`;
    mods.appendChild(el);
  });
  document.querySelectorAll('[data-mod]').forEach(b=>b.onclick = (e)=>{
    const id = +e.currentTarget.getAttribute('data-mod');
    startQuiz(id);
  });

  const r = document.getElementById("rankList");
  r.innerHTML = "";
  const all = [...S.rank.filter(x=>x.name!=="Voc√™"), {name:"Voc√™", xp:S.xp}].sort((a,b)=>b.xp-a.xp);
  all.forEach((it,i)=>{
    const d = document.createElement("div");
    d.className="row";
    d.innerHTML = `<div class="pill">#${i+1} ‚Äî <b>${it.name}</b></div><div class="pill">${t("xp")} ${it.xp}</div>`;
    r.appendChild(d);
  });
  const myIndex = all.findIndex(x=>x.name==="Voc√™");
  document.getElementById("rankMe").textContent = `#${myIndex+1}`;
}

// ====== LOGIN / STREAK ======
function doLogin(){
  const name = document.getElementById("inpName").value.trim() || (lang==="en"?"Player":(lang==="es"?"Jugador":"Jogador"));
  S.name = name;
  S.levelId = "Tecnico"; // sempre inicia em T√©cnico
  const tk = todayKey();
  if (S.lastLoginDay !== tk){
    S.streak = (S.lastLoginDay && ((new Date(tk) - new Date(S.lastLoginDay)) === 86400000)) ? (S.streak+1) : 1;
    S.lastLoginDay = tk;
  }
  save();
  document.getElementById("viewLogin").classList.add("hidden");
  const dash = document.getElementById("viewDash");
  dash.classList.remove("hidden");
  setTimeout(()=>dash.classList.add("show"),0);
  document.getElementById("btnLogout").classList.remove("hidden");
  renderDash();
  toast(t("welcome"));
}
document.getElementById("btnLogin").onclick = doLogin;
document.getElementById("btnLogout").onclick = () => {
  localStorage.removeItem(STATE_KEY);
  location.reload();
};

// ====== QUIZ ENGINE ======
let curQuiz = null;
let curIdx = 0;
let curScore = 0;
let curModId = 0;

function pickTen(qs){
  if (qs.length <= 10) return qs.slice();
  const arr = qs.slice();
  const out = [];
  while(out.length<10 && arr.length){
    const i = Math.floor(Math.random()*arr.length);
    out.push(arr.splice(i,1)[0]);
  }
  return out;
}

function startQuiz(modId){
  curModId = modId;
  const raw = QUIZZES[modId] || QUIZZES[13] || QUIZ_FALLBACK;
  curQuiz = pickTen(raw);
  curIdx = 0; curScore = 0;
  document.getElementById("quizTitle").textContent = `${t("modules_hdr")} #${modId}`;
  const ov = document.getElementById("quizOverlay");
  ov.style.display = "flex";
  document.getElementById("qExplain").classList.add("hidden");
  renderQuestion();
}
function closeQuiz(){ document.getElementById("quizOverlay").style.display = "none"; }
document.getElementById("btnCloseQuiz").onclick = closeQuiz;

function renderQuestion(){
  const q = curQuiz[curIdx];
  document.getElementById("qNum").textContent = (curIdx+1);
  document.getElementById("qText").textContent = q.q;
  const box = document.getElementById("qOpts");
  const exp = document.getElementById("qExplain");
  exp.classList.add("hidden");
  exp.textContent = "";
  box.innerHTML = "";

  const L = currentLevel();
  const XP_HIT = XP_PER_LEVEL[L.id] || 30;

  function addOpt(label, isCorrect){
    const div = document.createElement("div");
    div.className = "opt";
    div.textContent = label;
    div.onclick = ()=>{
      if (isCorrect){
        div.classList.add("correct"); curScore++;
        addXP(XP_HIT);
      } else {
        div.classList.add("wrong");
      }
      exp.textContent = q.exp || "";
      exp.classList.remove("hidden");
      box.querySelectorAll(".opt").forEach(o=>o.style.pointerEvents="none");
    };
    box.appendChild(div);
  }

  if (!q.type || q.type==="multi-choice"){
    q.opts.forEach((o,i)=> addOpt(o, i===q.ok));
  } else if (q.type==="text"){
    const inp = document.createElement("input");
    inp.placeholder = lang==="en"?"Type your answer...":(lang==="es"?"Escribe tu respuesta...":"Digite sua resposta...");
    box.appendChild(inp);
    const btn = document.createElement("button");
    btn.className = "btn"; btn.textContent = "Validar";
    btn.onclick = ()=>{
      const val = (inp.value||"").toLowerCase().trim();
      const arr = (q.answerText||[]).map(x=>x.toLowerCase());
      const ok = arr.some(x=> val.includes(x));
      if (ok){ addXP(XP_HIT); exp.textContent = q.exp||"Correto."; }
      else { exp.textContent = q.exp||"Revise o conceito."; }
      exp.classList.remove("hidden");
      btn.disabled = true;
    };
    box.appendChild(btn);
  } else if (q.type==="calc"){
    const inp = document.createElement("input"); inp.type="number"; inp.step="any";
    inp.placeholder = lang==="en"?"Value":"Valor";
    box.appendChild(inp);
    const btn = document.createElement("button");
    btn.className = "btn"; btn.textContent = "Calcular";
    btn.onclick = ()=>{
      const v = parseFloat(inp.value);
      const tol = q.tolerance ?? 0;
      const ok = Math.abs(v - q.answer) <= tol;
      if (ok){ addXP(XP_HIT); exp.textContent = q.exp||"Certo!"; }
      else { exp.textContent = `Esperado ‚âà ${q.answer}${q.unit?(" "+q.unit):""}. ${q.exp||""}`; }
      exp.classList.remove("hidden");
      btn.disabled = true;
    };
    box.appendChild(btn);
  } else if (q.type==="order"){
    const src = q.items.slice();
    const ul = document.createElement("div"); ul.className="row";
    src.forEach((it,i)=>{
      const p = document.createElement("div");
      p.className = "pill"; p.draggable = true; p.textContent = it;
      p.ondragstart = (e)=>{ e.dataTransfer.setData("text/plain", it); };
      ul.appendChild(p);
    });
    const target = document.createElement("div"); target.className="row"; target.style.minHeight="42px";
    target.ondragover = (e)=>e.preventDefault();
    target.ondrop = (e)=>{
      e.preventDefault();
      const t = e.dataTransfer.getData("text/plain");
      const el = Array.from(ul.children).find(x=>x.textContent===t);
      if (el){ target.appendChild(el); }
    };
    box.appendChild(ul);
    box.appendChild(target);
    const btn = document.createElement("button");
    btn.className="btn"; btn.textContent="Validar";
    btn.onclick = ()=>{
      const arr = Array.from(target.children).map(x=>x.textContent);
      const ok = JSON.stringify(arr) === JSON.stringify(q.correctOrder);
      if (ok){ addXP(XP_HIT); exp.textContent = q.exp||"Certo!"; }
      else { exp.textContent = `Ordem esperada: ${q.correctOrder.join(" ‚Üí ")}. ${q.exp||""}`; }
      exp.classList.remove("hidden");
      btn.disabled = true;
    };
    box.appendChild(btn);
  } else if (q.type==="multi"){
    const chosen = new Set();
    q.opts.forEach((o,i)=>{
      const d = document.createElement("div"); d.className="opt"; d.textContent=o;
      d.onclick = ()=>{
        if (chosen.has(i)){ chosen.delete(i); d.style.opacity=1; }
        else { chosen.add(i); d.style.opacity=.8; }
      };
      box.appendChild(d);
    });
    const btn = document.createElement("button"); btn.className="btn"; btn.textContent="Validar";
    btn.onclick = ()=>{
      const arr = Array.from(chosen).sort((a,b)=>a-b);
      const ok = JSON.stringify(arr) === JSON.stringify(q.ok.slice().sort((a,b)=>a-b));
      if (ok){ addXP(XP_HIT); exp.textContent = q.exp||"Perfeito!"; }
      else { exp.textContent = q.exp||"Revise os conceitos."; }
      exp.classList.remove("hidden");
      btn.disabled = true;
    };
    box.appendChild(btn);
  }
}
document.getElementById("btnNext").onclick = ()=>{
  if (!curQuiz) return;
  if (curIdx<curQuiz.length-1){ curIdx++; renderQuestion(); }
  else {
    const best = S.cleared[curModId]||0;
    if (curScore>best) S.cleared[curModId]=curScore;

    const tk = todayKey();
    if (curScore===10 && S.dailyDoneOn !== tk){
      S.dailyDoneOn = tk;
      addXP(20);
      toast(t("mission_daily_done"));
    }
    const mondayIso = mondayOfThisWeekISO();
    if (S.week.startIso !== mondayIso){ S.week.startIso = mondayIso; S.week.modulesDone = 0; }
    S.week.modulesDone = Math.min(3, S.week.modulesDone + 1);
    if (S.week.modulesDone === 3){
      addXP(100);
      toast(t("mission_week_done"));
    }
    save();
    toast(t("module_done", {id: String(curModId), score: String(curScore)}));
    closeQuiz();
    renderDash();
  }
};

// ====== CONFIG HANDLERS ======
document.getElementById("btnConfig").onclick = ()=>{
  document.getElementById("cfgOverlay").style.display = "flex";
  // hydrate controls
  document.getElementById("selTheme").value = Settings.theme;
  document.getElementById("chkSound").checked = !!Settings.sound;
  document.getElementById("chkConfetti").checked = !!Settings.confetti;
  applyI18n();
};
document.getElementById("btnCloseCfg").onclick = ()=>{
  document.getElementById("cfgOverlay").style.display = "none";
};
document.getElementById("selTheme").addEventListener("change", (e)=>{
  Settings.theme = e.target.value;
  saveSettings(); applyTheme();
});
document.getElementById("chkSound").addEventListener("change", (e)=>{
  Settings.sound = !!e.target.checked; saveSettings();
});
document.getElementById("chkConfetti").addEventListener("change", (e)=>{
  Settings.confetti = !!e.target.checked; saveSettings();
});
document.getElementById("langSel2").addEventListener("change", (e)=>{
  lang = e.target.value;
  localStorage.setItem("duoplanning.lang", lang);
  applyI18n(); renderDash();
});
document.getElementById("btnReset").onclick = ()=>{
  localStorage.removeItem(STATE_KEY);
  S = JSON.parse(localStorage.getItem(STATE_KEY) || "null") || {
    name:"", xp:0, energy:3, levelId:"Tecnico", streak:0, lastLoginDay:"",
    cleared:{}, week:{startIso:"", modulesDone:0}, dailyDoneOn:"",
    rank:[{name:"Voc√™", xp:0},{name:"Alice", xp:560},{name:"Bruno", xp:320}],
  };
  save();
  toast(t("saved"));
  renderDash();
};

// ====== INIT ======
applyI18n();
applyTheme();
if (S.name){
  document.getElementById("viewLogin").classList.add("hidden");
  const dash = document.getElementById("viewDash");
  dash.classList.remove("hidden");
  setTimeout(()=>dash.classList.add("show"),0);
  document.getElementById("btnLogout").classList.remove("hidden");
  renderDash();
}
</script>
</body>
</html>
